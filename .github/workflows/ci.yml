name: CI

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

# Cancel previous runs of the same branch/PR to save resources
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test

jobs:
  # ─────────────────────────────────────────────
  # 1. Lint, test, typecheck, build (monorepo)
  # ─────────────────────────────────────────────
  build-and-test:
    name: Lint, Test, Typecheck & Build
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      matrix:
        node-version: [18.x] # Keep in sync with .nvmrc and package.json "engines"

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      # Install dependencies (monorepo)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Lint (all workspace packages)
      - name: Lint
        run: pnpm lint

      # Test (all workspace packages)
      - name: Test
        run: pnpm test

      # Typecheck (all workspace packages, if script exists)
      - name: Typecheck
        run: pnpm typecheck

      # Build (all workspace packages)
      - name: Build
        run: pnpm build

      # (Optional) Upload coverage reports if you generate them
      # - name: Upload coverage artifact
      #   if: success()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: coverage-report
      #     path: coverage/

  # ─────────────────────────────────────────────
  # 2. Validate CLI only (fast feedback)
  # ─────────────────────────────────────────────
  cli-smoke:
    name: CLI smoke test
    runs-on: ubuntu-latest
    needs: build-and-test
    if: ${{ success() }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI
        run: pnpm --filter cli build

      - name: Smoke test CLI
        run: |
          node cli/dist/index.js --help
          node cli/dist/index.js list || true
        # Note: we allow "list" to fail gracefully in early alpha;
        # you can change this to a strict check when templates-registry is stable.

  # ─────────────────────────────────────────────
  # 3. (Optional) Website build check
  #    Runs only if /website exists and has a package.json
  # ─────────────────────────────────────────────
  website-build:
    name: Website build (if present)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: ${{ success() && hashFiles('website/package.json') != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build website
        run: pnpm --filter website build
