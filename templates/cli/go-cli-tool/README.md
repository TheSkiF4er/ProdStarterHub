# ProdStarter — Go CLI Tool

[![License: MIT](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

> Production-ready Go CLI template (Cobra + Viper + Zap + Prometheus). Opinionated defaults for configuration, structured logging, metrics, graceful shutdown, testing and reproducible builds.

---

## Contents

* Quickstart
* Highlights & features
* Project layout
* Prerequisites
* Build & run (local / Docker / CI)
* Configuration & precedence
* Commands & examples
* Logging, metrics & health
* Testing & quality gates
* Packaging & releases
* CI/CD recommendations
* Contributing
* License

---

## Quickstart

```bash
# copy the template into your workspace
cp -R ProdStarterHub/templates/cli/go-cli-tool ~/projects/my-tool
cd ~/projects/my-tool

# initialize module and tidy deps
go mod init github.com/yourorg/my-tool
go mod tidy

# build
go build -o bin/my-tool ./cmd/tool

# run help
./bin/my-tool --help
```

For a reproducible Docker-based build, use the provided `Dockerfile` (multi-stage):

```bash
docker build -t my-tool:build .
docker create --name tmp my-tool:build
docker cp tmp:/app/my-tool ./dist/my-tool
docker rm tmp
```

---

## Highlights & features

* Cobra CLI with subcommands and autogenerated help.
* Viper-based configuration (env + file + flags) with sensible defaults.
* Zap structured logging (dev vs production presets).
* Prometheus metrics server and health probes (`/metrics`, `/ready`, `/live`).
* Graceful shutdown with `context.Context` and signal handling (SIGINT/SIGTERM).
* Build-time versioning variables and reproducible build guidance.
* Template metadata (`template.json`) for automated scaffolding.
* Opinionated `ARCHITECTURE.md`, `TUTORIAL.md`, and `TASKS.md` to ship production-ready services.

---

## Project layout

```
cmd/tool/               # CLI entrypoint
internal/               # application, infra, config, logging, metrics
configs/                # example config files (dev/prod)
build/                  # helper scripts
test/                   # integration fixtures & helpers
Dockerfile
Makefile
go.mod
README.md
ARCHITECTURE.md
TUTORIAL.md
TASKS.md
template.json
```

`cmd/tool` contains a minimal `main.go` that boots config, logger and Cobra commands; real logic belongs in `internal/` for testability.

---

## Prerequisites

* Go toolchain (recommended pinned version in docs / CI, e.g. 1.20+).
* Git.
* Docker (optional) for reproducible builds.
* Optional tools: `golangci-lint`, `gofumpt`, `govulncheck`.

---

## Build & run

### Local build

```bash
# build
go build -o bin/my-tool ./cmd/tool

# run
./bin/my-tool run --input ./data.txt
```

Add build metadata:

```bash
VERSION=1.2.3
go build -trimpath -ldflags "-s -w -X main.version=${VERSION}" -o bin/my-tool ./cmd/tool
```

### Docker reproducible build

Use the multi-stage Dockerfile to build with an isolated toolchain and extract the artifact.

### CI builds

CI should run: `gofmt`/`gofumpt` check, `golangci-lint`, `go vet`, unit tests, `go test -race` (when applicable), `go build` for target platforms and produce artifacts.

---

## Configuration & precedence

Configuration precedence (highest → lowest):

1. CLI flags
2. Config file passed with `--config` (YAML/JSON/TOML)
3. Environment variables (prefix `TOOL_` by default)
4. Built-in defaults

Do not store secrets in VCS—use environment variables or secret managers for production.

---

## Commands & examples

The template includes these commands:

* `run` — primary processing command (supports `--input`, `--dry-run`).
* `serve-metrics` — starts Prometheus metrics and health endpoints.
* `config` — prints effective configuration.
* `version` — prints build metadata (version, commit, build time).

Example:

```bash
# dry-run processing
./bin/my-tool run --input ./payload.json --dry-run

# run metrics server
./bin/my-tool serve-metrics --listen ":9090"
```

---

## Logging, metrics & health

* Logging: Zap is used with human-readable development output and JSON production output. Control verbosity via flags or env.
* Metrics: Prometheus client library with a dedicated command to serve `/metrics`. Register counters and histograms in `internal/metrics`.
* Health: Serve `/ready` and `/live` endpoints for orchestration probes.

These components are intentionally optional and can be disabled for very small utilities.

---

## Testing & quality gates

* Unit tests: place under `internal/..._test.go` and run `go test ./...`.
* Integration tests: create `test/` fixtures; run in CI selectively.
* Linters & static analysis: run `golangci-lint` and `go vet` in CI.
* Security: run `govulncheck` in CI and review dependencies regularly.

---

## Packaging & releases

Produce platform-specific tarballs:

```
my-tool-<version>-<os>-<arch>.tar.gz
  ├─ my-tool
  ├─ LICENSE
  └─ USAGE.md
```

Provide SHA256 checksums and optional GPG signatures. Optionally publish minimal container images (Alpine / distroless) scanned with Trivy.

---

## CI/CD recommendations

* PR checks: formatting, lint, vet, unit tests.
* Release pipeline: build artifacts for a matrix of OS/arch, run smoke tests, sign artifacts, and publish to GitHub Releases or artifact registry.
* Use pinned Go versions via CI matrix and record build metadata in artifacts.

A sample GitHub Actions workflow can be added to `.github/workflows/` by enabling `IncludeCI` when scaffolding.

---

## Contributing

Contributions welcome. Suggested flow:

1. Fork and branch from `main`.
2. Run `gofmt`/`gofumpt`, linters and tests locally.
3. Open a PR with a clear description and reference related `TASKS.md` items.
4. Ensure CI passes and respond to review comments.

Please follow the coding style, include tests for new features, and update docs.

---

## License

This template is provided under the MIT License unless otherwise specified in `template.json`. See `LICENSE` for full text.
